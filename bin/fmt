#!/bin/sh

set -eu

go install -mod=readonly golang.org/x/tools/cmd/goimports

# go list will exclude the vendor directory.  We use grep to exclude generated
# code.
dirs=$(go list -f \{\{.Dir\}\} ./... | grep -v controller/gen)
# go list will list all subdirectories and goimports acts recursively.  This
# results in certain files being reported multiple time.  Therefore, we must
# dedup them.
files=$(goimports -l $dirs | sort | uniq)

if [ ! -z "$files" ]; then
  for file in $files; do
    goimports -d "$file"
  done
  exit 64
fi
